<!DOCTYPE html>
<html>
<head>
    <title>Signal Watcher Command Center</title>
    <style>
        body { font-family: sans-serif; text-align: center; transition: background 0.5s; padding: 50px; }
        .NORMAL { background-color: #2ecc71; color: white; }
        .CRITICAL { background-color: #e74c3c; color: white; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .card { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; display: inline-block; }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; border: none; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body class="NORMAL" id="bg">
    <div class="card">
        <h1>STATUS: <span id="status_text">INITIALIZING</span></h1>
        <p id="detail_text">Waiting for data...</p>
        <p><small id="time_text"></small></p>
        <button onclick="resetSystem()">RESET ALARM</button>
    </div>

    <audio id="alarmSound" loop>
        <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
    </audio>

    <script>
        const alarm = document.getElementById('alarmSound');
        
        // Step 2: Polling Function (Runs every 1 second)
        async function updateDashboard() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                document.getElementById('status_text').innerText = data.level;
                document.getElementById('detail_text').innerText = data.detail;
                document.getElementById('time_text').innerText = data.timestamp;
                document.getElementById('bg').className = data.level;

                // Step 3: Audio Logic
                if (data.level === 'CRITICAL') {
                    alarm.play(); // Warning: Browsers require one click on the page to allow audio
                } else {
                    alarm.pause();
                    alarm.currentTime = 0;
                }
            } catch (e) { console.log("Server not reachable"); }
        }

        async function resetSystem() {
            await fetch('/reset');
            updateDashboard();
        }

        setInterval(updateDashboard, 1000); // Poll every 1000ms
    </script>
</body>
</html>